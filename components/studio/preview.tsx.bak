"use client";

import React, { useRef, useEffect, useMemo } from 'react';
import { useStudio } from './studio-context';

// Panel backgrounds for each color theme
const panelBackgrounds: Record<string, string> = {
  black: 'bg-[#050505] border-white/5',
  white: 'bg-gray-100 border-black/10',
  yellow: 'bg-amber-200/80 border-amber-600/20',
  red: 'bg-red-300/80 border-red-700/20',
  green: 'bg-green-300/80 border-green-700/20',
  blue: 'bg-blue-300/80 border-blue-700/20',
};

const Preview = () => {
  const { isPlaying, clips, activeClipId, setCurrentTime, playNextClip, effects, colorTheme, isDark, randomSeekEnabled, randomSeekSpeed, randomSeekRange } = useStudio();
  const videoRef = useRef<HTMLVideoElement>(null);
  const activeClip = clips.find(c => c.id === activeClipId);

  // Build CSS filter string from effects
  const videoFilter = useMemo(() => {
    const filters: string[] = [];

    // Basic adjustments
    if (effects.brightness !== 100) filters.push(`brightness(${effects.brightness}%)`);
    if (effects.contrast !== 100) filters.push(`contrast(${effects.contrast}%)`);
    if (effects.saturation !== 100) filters.push(`saturate(${effects.saturation}%)`);
    if (effects.blur > 0) filters.push(`blur(${effects.blur}px)`);

    // Filter presets
    if (effects.sepia) filters.push('sepia(80%)');
    if (effects.vintage) filters.push('sepia(40%) contrast(90%) brightness(90%)');
    if (effects.noir) filters.push('grayscale(100%) contrast(120%)');
    if (effects.vibrant) filters.push('saturate(150%) contrast(110%)');
    if (effects.cool) filters.push('hue-rotate(20deg) saturate(90%)');
    if (effects.warm) filters.push('sepia(20%) saturate(120%)');

    return filters.length > 0 ? filters.join(' ') : 'none';
  }, [effects]);

  // Random Seek Effect - runs at ~60fps when playing and enabled
  useEffect(() => {
    if (!isPlaying || !randomSeekEnabled || !videoRef.current) return;

    const interval = setInterval(() => {
      const video = videoRef.current;
      if (!video || video.paused || !video.duration) return;

      // Random chance based on speed (speed% chance per frame at 60fps)
      // To make it feel right, we use seekChance per tick
      const seekChance = randomSeekSpeed / 100;
      if (Math.random() < seekChance) {
        const currentTime = video.currentTime;
        const duration = video.duration;
        const rangePercent = randomSeekRange / 100;
        const maxRange = duration * rangePercent;

        // Calculate random offset: -maxRange to +maxRange
        const offset = (Math.random() - 0.5) * 2 * maxRange;
        let newTime = currentTime + offset;

        // Clamp to video bounds
        newTime = Math.max(0, Math.min(duration, newTime));
        video.currentTime = newTime;
      }
    }, 1000 / 60); // ~60fps

    return () => clearInterval(interval);
  }, [isPlaying, randomSeekEnabled, randomSeekSpeed, randomSeekRange]);

  // Sync Playback State (Pause/Play toggles)
  useEffect(() => {
    if (videoRef.current) {
      if (isPlaying) {
        videoRef.current.play().catch(e => console.error("Play error:", e));
      } else {
        videoRef.current.pause();
      }
    }
  }, [isPlaying]);

  // Auto-play when clip changes if already playing
  useEffect(() => {
    if (isPlaying && videoRef.current) {
      videoRef.current.play().catch(e => console.error("Auto-play error:", e));
    }
  }, [activeClipId, isPlaying]);

  const handleTimeUpdate = () => {
    if (videoRef.current) {
      const duration = videoRef.current.duration || 1;
      const progress = videoRef.current.currentTime / duration;
      setCurrentTime(progress);
    }
  };

  return (
    <div className={`flex h-full w-full flex-none rounded-lg border overflow-hidden items-start justify-center pl-2 pt-2 pb-2 pr-2 relative ${panelBackgrounds[colorTheme] || panelBackgrounds.black}`}>
      {/* Phone-sized Container Constraint - Max Height 600px */}
      <div className={`relative w-full aspect-[9/16] max-h-[600px] rounded-xl border-4 shadow-2xl overflow-hidden flex items-center justify-center ${isDark ? 'bg-black border-zinc-900' : 'bg-gray-900 border-gray-700'}`}>
        {activeClip ? (
          <video
            ref={videoRef}
            src={activeClip.url}
            className="w-full h-full object-cover"
            style={{ filter: videoFilter }}
            autoPlay
            muted // Muted for autoplay policy
            playsInline
            onTimeUpdate={handleTimeUpdate}
            onEnded={playNextClip}
            onError={(e) => {
              console.error('ðŸš¨ Video load error:', {
                src: activeClip.url,
                filename: activeClip.filename,
                error: e.currentTarget.error,
                errorCode: e.currentTarget.error?.code,
                errorMessage: e.currentTarget.error?.message
              });
            }}
            onLoadedMetadata={() => {
              console.log('âœ… Video loaded successfully:', {
                url: activeClip.url,
                duration: videoRef.current?.duration,
                dimensions: `${videoRef.current?.videoWidth}x${videoRef.current?.videoHeight}`
              });
            }}
            onCanPlay={() => {
              console.log('â–¶ï¸ Video can play:', activeClip.filename);
            }}
          />
        ) : (
          <div className={`font-mono text-xs ${isDark ? 'text-zinc-600' : 'text-gray-400'}`}>No Active Clip</div>
        )}
      </div>
    </div>
  );
};

export default Preview;
