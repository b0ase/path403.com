name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (commit hash or tag)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test:run
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build application
        run: pnpm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Create backup
        run: |
          echo "Creating database backup..."
          ./scripts/backup-supabase-cloud.sh
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy to ${{ github.event.inputs.environment }}
        run: |
          echo "Deploying to ${{ github.event.inputs.environment }}..."
          # Add your deployment command here
          # Example: npm run deploy:${{ github.event.inputs.environment }}
        env:
          DEPLOYMENT_TOKEN: ${{ secrets.DEPLOYMENT_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Run smoke tests
        run: pnpm run test:smoke
        env:
          DEPLOYMENT_URL: ${{ secrets[format('DEPLOYMENT_URL_{0}', github.event.inputs.environment)] }}

      - name: Monitor deployment
        run: |
          echo "Monitoring deployment for 5 minutes..."
          for i in {1..30}; do
            curl -f ${{ secrets[format('DEPLOYMENT_URL_{0}', github.event.inputs.environment)] }}/api/health || exit 1
            sleep 10
          done

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: '${{ github.event.inputs.environment }}',
              production_environment: '${{ github.event.inputs.environment }}' === 'production',
              auto_merge: false,
              required_contexts: []
            });

      - name: Notify Slack on success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "✅ Deployment to ${{ github.event.inputs.environment }} succeeded",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Successful*\nEnvironment: ${{ github.event.inputs.environment }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "❌ Deployment to ${{ github.event.inputs.environment }} failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Failed*\nEnvironment: ${{ github.event.inputs.environment }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\n\n*Action Required: Review logs and consider rollback*"
                  }
                }
              ]
            }

  rollback:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: failure() && github.event.inputs.environment == 'production'
    needs: deploy

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous stable version
        id: previous
        run: |
          git log --oneline --all | grep -i "production-stable" | head -1 | awk '{print $1}'
          echo "PREVIOUS_HASH=$(git log --oneline --all | grep -i "production-stable" | head -1 | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Rollback to previous version
        if: steps.previous.outputs.PREVIOUS_HASH
        run: |
          echo "Rolling back to ${{ steps.previous.outputs.PREVIOUS_HASH }}"
          git checkout ${{ steps.previous.outputs.PREVIOUS_HASH }}

      - name: Notify team
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'URGENT: Production Deployment Rollback Triggered',
              body: `Deployment to production failed and was rolled back.\n\nPrevious stable version: ${{ steps.previous.outputs.PREVIOUS_HASH }}\n\n**Immediate Actions Required:**\n1. Investigate root cause\n2. Fix the issue\n3. Test thoroughly\n4. Redeploy\n\nAuthor: @${{ github.actor }}`
            });
