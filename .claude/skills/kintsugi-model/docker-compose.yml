# Kintsugi Agent Stack
# Two containers: Gateway (has secrets) + Agent (sandboxed)
#
# Deploy with: docker compose up -d
# Logs: docker compose logs -f
# Stop: docker compose down

version: '3.8'

services:
  # Gateway: Proxies requests, injects secrets, rate limits
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: kintsugi-gateway
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3001"  # Only accessible locally
    environment:
      - GATEWAY_PORT=3001
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - PIPELINE_API_URL=https://b0ase.com/api/pipeline
      - PIPELINE_API_KEY=${PIPELINE_API_KEY}
      - MAX_REQUESTS_PER_MINUTE=60
      - MAX_TOKENS_PER_HOUR=100000
    volumes:
      - kintsugi-logs:/var/log/kintsugi
    networks:
      - kintsugi-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Agent: Sandboxed Claude Code environment
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: kintsugi-agent
    restart: unless-stopped
    depends_on:
      gateway:
        condition: service_healthy
    # Security: Run as unprivileged user
    user: "1000:1000"
    # Security: Drop all capabilities
    cap_drop:
      - ALL
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
    # Security: Read-only root filesystem
    read_only: true
    # Temp filesystem for build artifacts
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=1g
      - /home/kintsugi/.npm:rw,size=500m
      - /home/kintsugi/.pnpm-store:rw,size=2g
    environment:
      - CLAUDE_CODE_GATEWAY=http://gateway:3001
      - NODE_ENV=production
      # Optional: Specific task to run (otherwise enters autonomous loop)
      # - KINTSUGI_TASK=Build the landing page for project X
    volumes:
      # Persistent project storage
      - kintsugi-projects:/home/kintsugi/projects
    networks:
      - kintsugi-net
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

networks:
  kintsugi-net:
    driver: bridge
    # Network isolation: Only gateway can reach external services
    internal: false

volumes:
  kintsugi-projects:
    driver: local
  kintsugi-logs:
    driver: local
