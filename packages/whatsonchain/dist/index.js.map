{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * @b0ase/whatsonchain\n *\n * WhatsOnChain BSV API client.\n *\n * @example\n * ```typescript\n * import { WhatsOnChain, createMainnetClient } from '@b0ase/whatsonchain';\n *\n * const woc = createMainnetClient();\n *\n * // Get address balance\n * const balance = await woc.getAddressBalance(address);\n * console.log(`Balance: ${balance.confirmed} sats`);\n *\n * // Get UTXOs\n * const utxos = await woc.getAddressUtxos(address);\n *\n * // Broadcast transaction\n * const txid = await woc.broadcastTx(rawTxHex);\n * ```\n *\n * @packageDocumentation\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/** Network type */\nexport type Network = 'main' | 'test' | 'stn';\n\n/** Address balance */\nexport interface AddressBalance {\n  confirmed: number;\n  unconfirmed: number;\n}\n\n/** UTXO */\nexport interface UTXO {\n  tx_hash: string;\n  tx_pos: number;\n  value: number;\n  height: number;\n}\n\n/** Transaction output */\nexport interface TxOutput {\n  value: number;\n  n: number;\n  scriptPubKey: {\n    asm: string;\n    hex: string;\n    type: string;\n    addresses?: string[];\n  };\n}\n\n/** Transaction input */\nexport interface TxInput {\n  txid: string;\n  vout: number;\n  scriptSig: {\n    asm: string;\n    hex: string;\n  };\n  sequence: number;\n}\n\n/** Transaction */\nexport interface Transaction {\n  txid: string;\n  hash: string;\n  version: number;\n  size: number;\n  locktime: number;\n  vin: TxInput[];\n  vout: TxOutput[];\n  blockhash?: string;\n  blockheight?: number;\n  confirmations?: number;\n  time?: number;\n  blocktime?: number;\n}\n\n/** Block header */\nexport interface BlockHeader {\n  hash: string;\n  confirmations: number;\n  height: number;\n  version: number;\n  versionHex: string;\n  merkleroot: string;\n  time: number;\n  mediantime: number;\n  nonce: number;\n  bits: string;\n  difficulty: number;\n  chainwork: string;\n  previousblockhash?: string;\n  nextblockhash?: string;\n}\n\n/** Chain info */\nexport interface ChainInfo {\n  chain: string;\n  blocks: number;\n  headers: number;\n  bestblockhash: string;\n  difficulty: number;\n  mediantime: number;\n  verificationprogress: number;\n  chainwork: string;\n}\n\n/** Exchange rate */\nexport interface ExchangeRate {\n  currency: string;\n  rate: number;\n}\n\n/** Client configuration */\nexport interface WocConfig {\n  network: Network;\n  apiKey?: string;\n  timeout?: number;\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst API_URLS: Record<Network, string> = {\n  main: 'https://api.whatsonchain.com/v1/bsv/main',\n  test: 'https://api.whatsonchain.com/v1/bsv/test',\n  stn: 'https://api.whatsonchain.com/v1/bsv/stn',\n};\n\nconst DEFAULT_TIMEOUT = 30000;\n\n// ============================================================================\n// WhatsOnChain Client\n// ============================================================================\n\n/**\n * WhatsOnChain API Client\n */\nexport class WhatsOnChain {\n  private baseUrl: string;\n  private apiKey?: string;\n  private timeout: number;\n\n  constructor(config: WocConfig) {\n    this.baseUrl = API_URLS[config.network];\n    this.apiKey = config.apiKey;\n    this.timeout = config.timeout || DEFAULT_TIMEOUT;\n  }\n\n  /**\n   * Fetch with timeout and error handling\n   */\n  private async fetch<T>(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<T> {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), this.timeout);\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n    };\n\n    if (this.apiKey) {\n      headers['woc-api-key'] = this.apiKey;\n    }\n\n    try {\n      const response = await fetch(`${this.baseUrl}${endpoint}`, {\n        ...options,\n        headers: { ...headers, ...options.headers },\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`WoC API error: ${response.status} - ${error}`);\n      }\n\n      const contentType = response.headers.get('content-type');\n      if (contentType?.includes('application/json')) {\n        return (await response.json()) as T;\n      }\n\n      return (await response.text()) as unknown as T;\n    } catch (error) {\n      clearTimeout(timeoutId);\n      if (error instanceof Error && error.name === 'AbortError') {\n        throw new Error(`Request timeout after ${this.timeout}ms`);\n      }\n      throw error;\n    }\n  }\n\n  // ==========================================================================\n  // Chain Info\n  // ==========================================================================\n\n  /**\n   * Get chain info\n   */\n  async getChainInfo(): Promise<ChainInfo> {\n    return this.fetch<ChainInfo>('/chain/info');\n  }\n\n  /**\n   * Get current block height\n   */\n  async getBlockHeight(): Promise<number> {\n    const info = await this.getChainInfo();\n    return info.blocks;\n  }\n\n  // ==========================================================================\n  // Address APIs\n  // ==========================================================================\n\n  /**\n   * Get address balance\n   */\n  async getAddressBalance(address: string): Promise<AddressBalance> {\n    return this.fetch<AddressBalance>(`/address/${address}/balance`);\n  }\n\n  /**\n   * Get address UTXOs\n   */\n  async getAddressUtxos(address: string): Promise<UTXO[]> {\n    return this.fetch<UTXO[]>(`/address/${address}/unspent`);\n  }\n\n  /**\n   * Get address history (transaction hashes)\n   */\n  async getAddressHistory(address: string): Promise<{ tx_hash: string }[]> {\n    return this.fetch<{ tx_hash: string }[]>(`/address/${address}/history`);\n  }\n\n  /**\n   * Check if address has been used\n   */\n  async isAddressUsed(address: string): Promise<boolean> {\n    const history = await this.getAddressHistory(address);\n    return history.length > 0;\n  }\n\n  // ==========================================================================\n  // Transaction APIs\n  // ==========================================================================\n\n  /**\n   * Get transaction by ID\n   */\n  async getTransaction(txid: string): Promise<Transaction> {\n    return this.fetch<Transaction>(`/tx/${txid}`);\n  }\n\n  /**\n   * Get raw transaction hex\n   */\n  async getRawTransaction(txid: string): Promise<string> {\n    return this.fetch<string>(`/tx/${txid}/hex`);\n  }\n\n  /**\n   * Broadcast raw transaction\n   */\n  async broadcastTx(txhex: string): Promise<string> {\n    const result = await this.fetch<string>('/tx/raw', {\n      method: 'POST',\n      body: JSON.stringify({ txhex }),\n    });\n    return result.replace(/\"/g, '');\n  }\n\n  /**\n   * Get transaction confirmations\n   */\n  async getConfirmations(txid: string): Promise<number> {\n    const tx = await this.getTransaction(txid);\n    return tx.confirmations || 0;\n  }\n\n  /**\n   * Check if transaction is confirmed\n   */\n  async isConfirmed(txid: string, minConfirmations: number = 1): Promise<boolean> {\n    const confirmations = await this.getConfirmations(txid);\n    return confirmations >= minConfirmations;\n  }\n\n  // ==========================================================================\n  // Block APIs\n  // ==========================================================================\n\n  /**\n   * Get block header by hash\n   */\n  async getBlockHeader(hash: string): Promise<BlockHeader> {\n    return this.fetch<BlockHeader>(`/block/${hash}/header`);\n  }\n\n  /**\n   * Get block header by height\n   */\n  async getBlockHeaderByHeight(height: number): Promise<BlockHeader> {\n    return this.fetch<BlockHeader>(`/block/height/${height}`);\n  }\n\n  // ==========================================================================\n  // Exchange Rate APIs\n  // ==========================================================================\n\n  /**\n   * Get BSV exchange rate\n   */\n  async getExchangeRate(): Promise<ExchangeRate> {\n    return this.fetch<ExchangeRate>('/exchangerate');\n  }\n\n  /**\n   * Get BSV price in USD\n   */\n  async getBsvPriceUsd(): Promise<number> {\n    const rate = await this.getExchangeRate();\n    return rate.rate;\n  }\n\n  // ==========================================================================\n  // Utility Methods\n  // ==========================================================================\n\n  /**\n   * Get explorer URL for transaction\n   */\n  getTxUrl(txid: string): string {\n    const network = this.baseUrl.includes('/test') ? 'test' : 'main';\n    const domain =\n      network === 'test' ? 'test.whatsonchain.com' : 'whatsonchain.com';\n    return `https://${domain}/tx/${txid}`;\n  }\n\n  /**\n   * Get explorer URL for address\n   */\n  getAddressUrl(address: string): string {\n    const network = this.baseUrl.includes('/test') ? 'test' : 'main';\n    const domain =\n      network === 'test' ? 'test.whatsonchain.com' : 'whatsonchain.com';\n    return `https://${domain}/address/${address}`;\n  }\n\n  /**\n   * Get explorer URL for block\n   */\n  getBlockUrl(hashOrHeight: string | number): string {\n    const network = this.baseUrl.includes('/test') ? 'test' : 'main';\n    const domain =\n      network === 'test' ? 'test.whatsonchain.com' : 'whatsonchain.com';\n    return `https://${domain}/block/${hashOrHeight}`;\n  }\n}\n\n// ============================================================================\n// Factory Functions\n// ============================================================================\n\n/**\n * Create mainnet client\n */\nexport function createMainnetClient(apiKey?: string): WhatsOnChain {\n  return new WhatsOnChain({ network: 'main', apiKey });\n}\n\n/**\n * Create testnet client\n */\nexport function createTestnetClient(apiKey?: string): WhatsOnChain {\n  return new WhatsOnChain({ network: 'test', apiKey });\n}\n\n/**\n * Create client for any network\n */\nexport function createClient(\n  network: Network,\n  apiKey?: string\n): WhatsOnChain {\n  return new WhatsOnChain({ network, apiKey });\n}\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\n/**\n * Convert satoshis to BSV\n */\nexport function satsToBsv(sats: number): number {\n  return sats / 100000000;\n}\n\n/**\n * Convert BSV to satoshis\n */\nexport function bsvToSats(bsv: number): number {\n  return Math.round(bsv * 100000000);\n}\n\n/**\n * Format satoshis as BSV string\n */\nexport function formatBsv(sats: number, decimals: number = 8): string {\n  return satsToBsv(sats).toFixed(decimals);\n}\n\n/**\n * Validate BSV address format (basic check)\n */\nexport function isValidAddress(address: string): boolean {\n  // BSV addresses start with 1 (P2PKH) or 3 (P2SH)\n  if (!/^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(address)) {\n    return false;\n  }\n  return true;\n}\n\n/**\n * Validate transaction ID format\n */\nexport function isValidTxid(txid: string): boolean {\n  return /^[a-fA-F0-9]{64}$/.test(txid);\n}\n"],"mappings":"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","names":[]}