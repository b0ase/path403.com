(function(i,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("bsv-wasm"),require("axios"),require("nanoid")):typeof define=="function"&&define.amd?define(["exports","bsv-wasm","axios","nanoid"],o):(i=typeof globalThis<"u"?globalThis:i||self,o(i["HandCash Connect SDK"]={},i.bsvWasm,i.axios,i.nanoid))})(this,function(i,o,w,v){"use strict";const m=(u=>u&&typeof u=="object"&&"default"in u?u:{default:u})(w);class S extends Error{httpStatusCode;info;constructor(e,t,s){super(),this.httpStatusCode=e,this.message=t,this.info=s}toString(){return JSON.stringify(this)}}class r{httpRequestFactory;constructor(e){this.httpRequestFactory=e}async getCurrentProfile(){const e=this.httpRequestFactory.getCurrentProfileRequest();return r.handleRequest(e)}async getPublicProfilesByHandle(e){const t=this.httpRequestFactory.getPublicProfilesByHandleRequest(e);return r.handleRequest(t)}async getUserPermissions(){const e=this.httpRequestFactory.getUserPermissionsRequest();return r.handleRequest(e)}async getEncryptionKeypair(e){const t=this.httpRequestFactory.getEncryptionKeypairRequest(e);return r.handleRequest(t)}async signData(e){const t=this.httpRequestFactory.getDataSignatureRequest(e);return r.handleRequest(t)}async getUserFriends(){const e=this.httpRequestFactory.getUserFriendsRequest();return r.handleRequest(e)}async getSpendableBalance(e){const t=this.httpRequestFactory.getSpendableBalanceRequest(e);return r.handleRequest(t)}async getTotalBalance(){const e=this.httpRequestFactory.getTotalBalanceRequest();return r.handleRequest(e)}async pay(e){const t=this.httpRequestFactory.getPayRequest(e);return r.handleRequest(t)}async getPayment(e){const t=this.httpRequestFactory.getPaymentRequest({transactionId:e});return r.handleRequest(t)}async getExchangeRate(e){const t=this.httpRequestFactory.getExchangeRateRequest(e);return r.handleRequest(t)}async pursePay(e,t){const s=this.httpRequestFactory.getPursePayRequest(e,t);return r.handleRequest(s)}async purseBroadcast(e){const t=this.httpRequestFactory.getPurseBroadcastRequest(e);return r.handleRequest(t)}async ownerNextAddress(e){const t=this.httpRequestFactory.getOwnerNextAddressRequest(e);return r.handleRequest(t)}async ownerSign(e,t,s){const n=this.httpRequestFactory.getOwnerSignRequest(e,t,s);return r.handleRequest(n)}async getNftLocations(){const e=this.httpRequestFactory.getNftLocationsRequest();return r.handleRequest(e)}async requestEmailCode(e){const t=this.httpRequestFactory.requestEmailCodeRequest(e);return(await r.handleRequest(t)).requestId.requestId}async verifyEmailCode(e,t,s){const n=this.httpRequestFactory.verifyEmailCodeRequest(e,t,s);return r.handleRequest(n)}async createNewAccount(e,t,s){const n=this.httpRequestFactory.createNewAccountRequest(e,t,s);return r.handleRequest(n)}static async handleRequest(e){return m.default(e).then(t=>t.data).catch(r.handleApiError)}static handleApiError(e){return!e.response||!e.response.status?Promise.reject(e):Promise.reject(new S(e.response.status,e.response.data.message,e.response.data.info))}}const p="/v1/connect/profile",C="/v1/connect/account",y="/v1/connect/wallet",g="/v1/connect/runExtension";class c{privateKey;appSecret;appId;baseApiEndpoint;baseTrustholderEndpoint;constructor({authToken:e,appSecret:t,appId:s,baseApiEndpoint:n,baseTrustholderEndpoint:a}){if(e)try{this.privateKey=o.PrivateKey.from_hex(e)}catch{throw Error("Invalid authToken")}if(!t)throw Error("Missing appSecret");if(!s)throw Error("Missing appId");this.appSecret=t,this.appId=s,this.baseApiEndpoint=n,this.baseTrustholderEndpoint=a}getRequest(e,t,s={},n={}){const a=new Date().toISOString(),h=v.nanoid(),d=JSON.stringify(s)==="{}"?"":JSON.stringify(s),R=c.getEncodedEndpoint(t,n),l={"app-id":this.appId,"app-secret":this.appSecret,accept:"application/json"};if(d.length>0&&(l["content-type"]="application/json"),this.privateKey){const x=this.privateKey.to_public_key();l["oauth-publickey"]=x.to_hex(),l["oauth-timestamp"]=a.toString(),l["oauth-nonce"]=h,l["oauth-signature"]=c.getRequestSignature(e,R,d,a,this.privateKey,h)}return{baseURL:this.baseApiEndpoint,url:R,method:e,headers:l,data:d,responseType:"json"}}getTrustholderRequest(e,t,s,n={}){const a=c.getEncodedEndpoint(t,n);return{baseURL:this.baseTrustholderEndpoint,url:a,method:e,headers:{},data:s,responseType:"json"}}static getEncodedEndpoint(e,t){return m.default.getUri({url:e,params:t})}static getRequestSignature(e,t,s,n,a,h){const d=c.getRequestSignaturePayload(e,t,s,n,h);return a.sign_message(Buffer.from(d)).to_hex()}static getRequestSignaturePayload(e,t,s,n,a){return`${e}
${t}
${n}
${s}${a?`
${a}`:""}`}getCurrentProfileRequest(){return this.getRequest("GET",`${p}/currentUserProfile`)}getPublicProfilesByHandleRequest(e){const t=e.map((s,n)=>[`aliases[${n}]`,s]);return this.getRequest("GET",`${p}/publicUserProfiles`,{},{...Object.fromEntries(t)})}requestEmailCodeRequest=e=>this.getRequest("POST",`${C}/requestEmailCode`,{email:e});verifyEmailCodeRequest=(e,t,s)=>this.getTrustholderRequest("POST","/auth/verifyCode",{requestId:e,verificationCode:t,publicKey:s});createNewAccountRequest=(e,t,s)=>this.getRequest("POST",`${C}`,{accessPublicKey:e,email:t,referrerAlias:s});getUserFriendsRequest(){return this.getRequest("GET",`${p}/friends`)}getUserPermissionsRequest(){return this.getRequest("GET",`${p}/permissions`)}getEncryptionKeypairRequest(e){return this.getRequest("GET",`${p}/encryptionKeypair`,{},{encryptionPublicKey:e})}getDataSignatureRequest(e){return this.getRequest("POST",`${p}/signData`,{format:e.format,value:e.value})}getSpendableBalanceRequest(e){return this.getRequest("GET",`${y}/spendableBalance`,{},e?{currencyCode:e}:{})}getTotalBalanceRequest(){return this.getRequest("GET",`${y}/balance`)}getPayRequest(e){return this.getRequest("POST",`${y}/pay`,{description:e.description,appAction:e.appAction,receivers:e.payments,attachment:e.attachment})}getPaymentRequest(e){return this.getRequest("GET",`${y}/payment`,{},e)}getExchangeRateRequest(e){return this.getRequest("GET",`${y}/exchangeRate/${e}`,{})}getPursePayRequest(e,t){return this.getRequest("POST",`${g}/purse/pay`,{rawTransaction:e,inputParents:t})}getPurseBroadcastRequest(e){return this.getRequest("POST",`${g}/purse/broadcast`,{rawTransaction:e})}getOwnerNextAddressRequest(e){return this.getRequest("GET",`${g}/owner/next`,{},{alias:e})}getOwnerSignRequest(e,t,s){return this.getRequest("POST",`${g}/owner/sign`,{rawTransaction:e,inputParents:t,locks:s})}getNftLocationsRequest(){return this.getRequest("GET",`${g}/owner/nftLocations`,{})}}class b{handCashConnectService;constructor(e){this.handCashConnectService=e}async getSpendableBalance(e){return this.handCashConnectService.getSpendableBalance(e)}async getTotalBalance(){return this.handCashConnectService.getTotalBalance()}async pay(e){return this.handCashConnectService.pay(e)}async getPayment(e){return this.handCashConnectService.getPayment(e)}async getExchangeRate(e){return this.handCashConnectService.getExchangeRate(e)}}class T{handCashConnectService;constructor(e){this.handCashConnectService=e}async getCurrentProfile(){return this.handCashConnectService.getCurrentProfile()}async getPublicProfilesByHandle(e){return this.handCashConnectService.getPublicProfilesByHandle(e).then(t=>t.items)}async getFriends(){return this.handCashConnectService.getUserFriends().then(e=>e.items)}async getPermissions(){return this.handCashConnectService.getUserPermissions().then(e=>e.items)}async getPermissionsInfo(){return this.handCashConnectService.getUserPermissions().then(e=>e)}async getEncryptionKeypair(){const e=o.PrivateKey.from_random(),t=await this.handCashConnectService.getEncryptionKeypair(e.to_public_key().to_hex()),s=o.PublicKey.from_hex(t.senderPublicKeyHex);return{publicKey:Buffer.from(o.ECIES.decrypt(o.ECIESCiphertext.from_bytes(Buffer.from(t.encryptedPublicKeyHex,"hex"),!0),e,s)).toString(),privateKey:Buffer.from(o.ECIES.decrypt(o.ECIESCiphertext.from_bytes(Buffer.from(t.encryptedPrivateKeyHex,"hex"),!0),e,s)).toString()}}async signData(e){return this.handCashConnectService.signData(e)}}class E{wallet;profile;constructor(e,t){this.wallet=e,this.profile=t}static fromAuthToken({authToken:e,appSecret:t,appId:s,baseApiEndpoint:n,baseTrustholderEndpoint:a}){const h=new r(new c({authToken:e,baseApiEndpoint:n,baseTrustholderEndpoint:a,appSecret:t,appId:s})),d=new b(h),R=new T(h);return new E(d,R)}}const q={prod:{apiEndpoint:"https://cloud.handcash.io",clientUrl:"https://app.handcash.io",trustholderEndpoint:"https://trust.hastearcade.com"},beta:{apiEndpoint:"https://beta-cloud.handcash.io",clientUrl:"https://beta-app.handcash.io",trustholderEndpoint:"https://trust.dev.hastearcade.com"},iae:{apiEndpoint:"https://iae.cloud.handcash.io",clientUrl:"https://iae-app.handcash.io",trustholderEndpoint:"http://trustholder-service-iae.us-east-1.elasticbeanstalk.com"}};class A{appId;appSecret;handCashConnectService;env;constructor({appId:e,appSecret:t,env:s=q.prod}){this.appId=e,this.appSecret=t,this.env=s,this.handCashConnectService=new r(new c({appId:this.appId,appSecret:this.appSecret,baseApiEndpoint:this.env.apiEndpoint,baseTrustholderEndpoint:this.env.trustholderEndpoint}))}getRedirectionUrl(e={}){e.appId=this.appId;const t=Object.entries(e).map(([s,n])=>`${encodeURIComponent(s)}=${encodeURIComponent(n.toString())}`).join("&");return`${this.env.clientUrl}/#/authorizeApp?${t}`}getChangeSpendLimitsUrl(e){return`${this.env.clientUrl}/#/settings/spendLimits`+(e?`?redirectUrl=${e}`:"")}generateAuthenticationKeyPair=()=>{const e=o.PrivateKey.from_random(),t=e.to_public_key();return{privateKey:e.to_hex(),publicKey:t.to_hex()}};requestEmailCode(e){return this.handCashConnectService.requestEmailCode(e)}verifyEmailCode(e,t,s){return this.handCashConnectService.verifyEmailCode(e,t,s)}createNewAccount(e,t,s){return this.handCashConnectService.createNewAccount(e,t,s)}getAccountFromAuthToken(e){return E.fromAuthToken({authToken:e,appSecret:this.appSecret,appId:this.appId,baseApiEndpoint:this.env.apiEndpoint,baseTrustholderEndpoint:this.env.trustholderEndpoint})}}class f{handCashConnectService;constructor(e){this.handCashConnectService=e}static fromAuthToken(e,t=q.prod,s="",n=""){const a=new r(new c({authToken:e,baseApiEndpoint:t.apiEndpoint,baseTrustholderEndpoint:t.trustholderEndpoint,appSecret:s,appId:n}));return new f(a)}async pay(e,t){return(await this.handCashConnectService.pursePay(e,t)).partiallySignedTx}async broadcast(e){await this.handCashConnectService.purseBroadcast(e)}}class P{handCashConnectService;constructor(e){this.handCashConnectService=e}static fromAuthToken(e,t=q.prod,s="",n=""){const a=new r(new c({authToken:e,baseApiEndpoint:t.apiEndpoint,baseTrustholderEndpoint:t.trustholderEndpoint,appSecret:s,appId:n}));return new P(a)}async nextOwner(e){return(await this.handCashConnectService.ownerNextAddress(e)).ownerAddress}async sign(e,t,s){return(await this.handCashConnectService.ownerSign(e,t,s)).signedTransaction}async getNftLocations(){return(await this.handCashConnectService.getNftLocations()).nftLocations}}const $={Pay:"PAY",UserPublicProfile:"USER_PUBLIC_PROFILE",UserPrivateProfile:"USER_PRIVATE_PROFILE",Friends:"FRIENDS",Decryption:"DECRYPTION",SignData:"SIGN_DATA",ReadBalance:"READ_BALANCE"};i.Environments=q,i.HandCashConnect=A,i.HandCashConnectApiError=S,i.HandCashOwner=P,i.HandCashPurse=f,i.Permissions=$,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
