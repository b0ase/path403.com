{"version":3,"sources":["../src/container.ts"],"sourcesContent":["/**\n * @b0ase/nft-container - Container creation and management\n */\n\nimport type {\n  NFTContainer,\n  FTContainer,\n  Container,\n  CreateNFTContainerInput,\n  CreateFTContainerInput,\n  FileMetadata,\n  BlockchainRef,\n  StorageRef,\n  ProvenanceEntry,\n  OwnershipRecord,\n} from './types';\n\n// ============================================================================\n// Utilities\n// ============================================================================\n\n/**\n * Generate unique container ID\n */\nfunction generateId(prefix: string): string {\n  return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * Calculate SHA-256 hash of content\n * Note: In Node.js, use crypto.createHash('sha256')\n * In browser, use crypto.subtle.digest('SHA-256', ...)\n */\nexport async function hashContent(content: Uint8Array): Promise<string> {\n  // Check if we're in a browser-like environment with crypto.subtle\n  if (\n    typeof globalThis !== 'undefined' &&\n    globalThis.crypto?.subtle?.digest\n  ) {\n    const hashBuffer = await globalThis.crypto.subtle.digest('SHA-256', content);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');\n  }\n\n  // Fallback: compute simple checksum (not cryptographically secure)\n  // In production, use proper crypto library\n  let hash = 0;\n  for (let i = 0; i < content.length; i++) {\n    hash = ((hash << 5) - hash + content[i]) | 0;\n  }\n  return Math.abs(hash).toString(16).padStart(8, '0');\n}\n\n/**\n * Get file extension from filename\n */\nfunction getExtension(filename: string): string {\n  const parts = filename.split('.');\n  return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';\n}\n\n// ============================================================================\n// NFT Container Creation\n// ============================================================================\n\n/**\n * Create an NFT container\n */\nexport async function createNFTContainer(\n  input: CreateNFTContainerInput\n): Promise<NFTContainer> {\n  const now = new Date();\n  const id = generateId('nft');\n\n  // Calculate content hash if content is provided\n  let contentHash = '';\n  if (input.file.content) {\n    contentHash = await hashContent(input.file.content);\n  }\n\n  const file: FileMetadata = {\n    name: input.file.name,\n    mimeType: input.file.mimeType,\n    size: input.file.size,\n    contentHash,\n    extension: getExtension(input.file.name),\n    createdAt: now,\n  };\n\n  // Create initial provenance entry\n  const provenance: ProvenanceEntry[] = [\n    {\n      event: 'created',\n      to: input.creators[0]?.address,\n      timestamp: now,\n    },\n  ];\n\n  return {\n    version: '1.0',\n    type: 'nft',\n    id,\n    file,\n    token: input.token,\n    creators: input.creators,\n    provenance,\n    blockchainRefs: input.blockchainRefs || [],\n    storageRefs: input.storageRefs || [],\n    createdAt: now,\n    updatedAt: now,\n    metadata: input.metadata,\n    content: input.file.content,\n  };\n}\n\n/**\n * Create an FT container\n */\nexport function createFTContainer(input: CreateFTContainerInput): FTContainer {\n  const now = new Date();\n  const id = generateId('ft');\n\n  return {\n    version: '1.0',\n    type: 'ft',\n    id,\n    token: input.token,\n    supply: {\n      totalSupply: input.supply.totalSupply,\n      circulatingSupply: input.supply.circulatingSupply ?? input.supply.totalSupply,\n      decimals: input.supply.decimals,\n      mintable: input.supply.mintable,\n      burnable: input.supply.burnable,\n      maxSupply: input.supply.maxSupply,\n    },\n    creators: input.creators,\n    blockchainRefs: input.blockchainRefs || [],\n    createdAt: now,\n    updatedAt: now,\n    metadata: input.metadata,\n  };\n}\n\n// ============================================================================\n// Container Updates\n// ============================================================================\n\n/**\n * Add blockchain reference to container\n */\nexport function addBlockchainRef<T extends Container>(\n  container: T,\n  ref: BlockchainRef\n): T {\n  return {\n    ...container,\n    blockchainRefs: [...container.blockchainRefs, ref],\n    updatedAt: new Date(),\n  };\n}\n\n/**\n * Add storage reference to NFT container\n */\nexport function addStorageRef(\n  container: NFTContainer,\n  ref: StorageRef\n): NFTContainer {\n  return {\n    ...container,\n    storageRefs: [...container.storageRefs, ref],\n    updatedAt: new Date(),\n  };\n}\n\n/**\n * Record ownership transfer\n */\nexport function transferOwnership(\n  container: NFTContainer,\n  newOwner: string,\n  options?: {\n    price?: number;\n    currency?: string;\n    txRef?: BlockchainRef;\n  }\n): NFTContainer {\n  const now = new Date();\n  const previousOwner = container.ownership?.owner;\n\n  const ownership: OwnershipRecord = {\n    owner: newOwner,\n    since: now,\n    acquisitionType: options?.price ? 'purchase' : 'transfer',\n    price: options?.price,\n    currency: options?.currency,\n    txRef: options?.txRef,\n  };\n\n  const provenanceEntry: ProvenanceEntry = {\n    event: options?.price ? 'sold' : 'transferred',\n    from: previousOwner,\n    to: newOwner,\n    price: options?.price,\n    currency: options?.currency,\n    timestamp: now,\n    txRef: options?.txRef,\n  };\n\n  return {\n    ...container,\n    ownership,\n    provenance: [...container.provenance, provenanceEntry],\n    updatedAt: now,\n  };\n}\n\n/**\n * Mark container as burned\n */\nexport function burnContainer(\n  container: NFTContainer,\n  txRef?: BlockchainRef\n): NFTContainer {\n  const now = new Date();\n\n  const provenanceEntry: ProvenanceEntry = {\n    event: 'burned',\n    from: container.ownership?.owner,\n    timestamp: now,\n    txRef,\n  };\n\n  return {\n    ...container,\n    provenance: [...container.provenance, provenanceEntry],\n    updatedAt: now,\n    metadata: {\n      ...container.metadata,\n      burned: true,\n      burnedAt: now.toISOString(),\n    },\n  };\n}\n\n// ============================================================================\n// Container Validation\n// ============================================================================\n\n/** Validation result */\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n  warnings: string[];\n}\n\n/**\n * Validate container structure\n */\nexport function validateContainer(container: Container): ValidationResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n\n  // Check required fields\n  if (!container.version) errors.push('Missing version');\n  if (!container.type) errors.push('Missing type');\n  if (!container.id) errors.push('Missing id');\n  if (!container.token?.name) errors.push('Missing token name');\n  if (!container.token?.symbol) errors.push('Missing token symbol');\n  if (container.creators.length === 0) errors.push('At least one creator required');\n\n  // Type-specific validation\n  if (container.type === 'nft') {\n    const nft = container as NFTContainer;\n    if (!nft.file?.name) errors.push('Missing file name');\n    if (!nft.file?.mimeType) errors.push('Missing file MIME type');\n    if (nft.file?.size <= 0) errors.push('Invalid file size');\n  } else if (container.type === 'ft') {\n    const ft = container as FTContainer;\n    if (ft.supply.totalSupply <= BigInt(0)) {\n      errors.push('Total supply must be positive');\n    }\n    if (ft.supply.decimals < 0 || ft.supply.decimals > 18) {\n      errors.push('Decimals must be 0-18');\n    }\n  }\n\n  // Warnings\n  if (container.blockchainRefs.length === 0) {\n    warnings.push('No blockchain references (not minted)');\n  }\n  if (container.type === 'nft') {\n    const nft = container as NFTContainer;\n    if (nft.storageRefs.length === 0) {\n      warnings.push('No storage references (file not uploaded)');\n    }\n    if (!nft.file?.contentHash) {\n      warnings.push('No content hash (integrity cannot be verified)');\n    }\n  }\n\n  // Creator validation\n  const totalShare = container.creators.reduce((sum, c) => sum + c.share, 0);\n  if (Math.abs(totalShare - 100) > 0.01) {\n    warnings.push(`Creator shares sum to ${totalShare}%, expected 100%`);\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n// ============================================================================\n// Container Type Guards\n// ============================================================================\n\n/**\n * Check if container is NFT\n */\nexport function isNFTContainer(container: Container): container is NFTContainer {\n  return container.type === 'nft';\n}\n\n/**\n * Check if container is FT\n */\nexport function isFTContainer(container: Container): container is FTContainer {\n  return container.type === 'ft';\n}\n\n/**\n * Check if container is minted\n */\nexport function isMinted(container: Container): boolean {\n  return container.blockchainRefs.some((ref) => ref.txid || ref.inscriptionId);\n}\n\n/**\n * Check if NFT container file is stored\n */\nexport function isStored(container: NFTContainer): boolean {\n  return container.storageRefs.length > 0;\n}\n\n// ============================================================================\n// Container Serialization\n// ============================================================================\n\n/**\n * Serialize container to JSON (for .nft/.ft file)\n */\nexport function serializeContainer(container: Container): string {\n  // Create a copy without binary content\n  const serializable = { ...container };\n  if (isNFTContainer(serializable) && serializable.content) {\n    // Convert Uint8Array to base64 for JSON serialization\n    const base64 = Buffer.from(serializable.content).toString('base64');\n    (serializable as Record<string, unknown>).contentBase64 = base64;\n    delete (serializable as Record<string, unknown>).content;\n  }\n\n  // Convert bigint to string for JSON\n  return JSON.stringify(\n    serializable,\n    (_, value) => (typeof value === 'bigint' ? value.toString() + 'n' : value),\n    2\n  );\n}\n\n/**\n * Deserialize container from JSON\n */\nexport function deserializeContainer(json: string): Container {\n  const parsed = JSON.parse(json, (_, value) => {\n    // Convert bigint strings back\n    if (typeof value === 'string' && value.endsWith('n')) {\n      const num = value.slice(0, -1);\n      if (/^\\d+$/.test(num)) {\n        return BigInt(num);\n      }\n    }\n    // Convert date strings back\n    if (typeof value === 'string' && /^\\d{4}-\\d{2}-\\d{2}T/.test(value)) {\n      return new Date(value);\n    }\n    return value;\n  });\n\n  // Restore binary content from base64\n  if (parsed.contentBase64) {\n    parsed.content = new Uint8Array(Buffer.from(parsed.contentBase64, 'base64'));\n    delete parsed.contentBase64;\n  }\n\n  return parsed as Container;\n}\n\n/**\n * Get container file extension\n */\nexport function getContainerExtension(container: Container): string {\n  return container.type === 'nft' ? '.nft' : '.ft';\n}\n\n/**\n * Get container filename\n */\nexport function getContainerFilename(container: Container): string {\n  const baseName = container.token.symbol.toLowerCase();\n  return `${baseName}${getContainerExtension(container)}`;\n}\n"],"mappings":";AAwBA,SAAS,WAAW,QAAwB;AAC1C,SAAO,GAAG,MAAM,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAC3E;AAOA,eAAsB,YAAY,SAAsC;AAEtE,MACE,OAAO,eAAe,eACtB,WAAW,QAAQ,QAAQ,QAC3B;AACA,UAAM,aAAa,MAAM,WAAW,OAAO,OAAO,OAAO,WAAW,OAAO;AAC3E,UAAM,YAAY,MAAM,KAAK,IAAI,WAAW,UAAU,CAAC;AACvD,WAAO,UAAU,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAAA,EACtE;AAIA,MAAI,OAAO;AACX,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,YAAS,QAAQ,KAAK,OAAO,QAAQ,CAAC,IAAK;AAAA,EAC7C;AACA,SAAO,KAAK,IAAI,IAAI,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG;AACpD;AAKA,SAAS,aAAa,UAA0B;AAC9C,QAAM,QAAQ,SAAS,MAAM,GAAG;AAChC,SAAO,MAAM,SAAS,IAAI,MAAM,MAAM,SAAS,CAAC,EAAE,YAAY,IAAI;AACpE;AASA,eAAsB,mBACpB,OACuB;AACvB,QAAM,MAAM,oBAAI,KAAK;AACrB,QAAM,KAAK,WAAW,KAAK;AAG3B,MAAI,cAAc;AAClB,MAAI,MAAM,KAAK,SAAS;AACtB,kBAAc,MAAM,YAAY,MAAM,KAAK,OAAO;AAAA,EACpD;AAEA,QAAM,OAAqB;AAAA,IACzB,MAAM,MAAM,KAAK;AAAA,IACjB,UAAU,MAAM,KAAK;AAAA,IACrB,MAAM,MAAM,KAAK;AAAA,IACjB;AAAA,IACA,WAAW,aAAa,MAAM,KAAK,IAAI;AAAA,IACvC,WAAW;AAAA,EACb;AAGA,QAAM,aAAgC;AAAA,IACpC;AAAA,MACE,OAAO;AAAA,MACP,IAAI,MAAM,SAAS,CAAC,GAAG;AAAA,MACvB,WAAW;AAAA,IACb;AAAA,EACF;AAEA,SAAO;AAAA,IACL,SAAS;AAAA,IACT,MAAM;AAAA,IACN;AAAA,IACA;AAAA,IACA,OAAO,MAAM;AAAA,IACb,UAAU,MAAM;AAAA,IAChB;AAAA,IACA,gBAAgB,MAAM,kBAAkB,CAAC;AAAA,IACzC,aAAa,MAAM,eAAe,CAAC;AAAA,IACnC,WAAW;AAAA,IACX,WAAW;AAAA,IACX,UAAU,MAAM;AAAA,IAChB,SAAS,MAAM,KAAK;AAAA,EACtB;AACF;AAKO,SAAS,kBAAkB,OAA4C;AAC5E,QAAM,MAAM,oBAAI,KAAK;AACrB,QAAM,KAAK,WAAW,IAAI;AAE1B,SAAO;AAAA,IACL,SAAS;AAAA,IACT,MAAM;AAAA,IACN;AAAA,IACA,OAAO,MAAM;AAAA,IACb,QAAQ;AAAA,MACN,aAAa,MAAM,OAAO;AAAA,MAC1B,mBAAmB,MAAM,OAAO,qBAAqB,MAAM,OAAO;AAAA,MAClE,UAAU,MAAM,OAAO;AAAA,MACvB,UAAU,MAAM,OAAO;AAAA,MACvB,UAAU,MAAM,OAAO;AAAA,MACvB,WAAW,MAAM,OAAO;AAAA,IAC1B;AAAA,IACA,UAAU,MAAM;AAAA,IAChB,gBAAgB,MAAM,kBAAkB,CAAC;AAAA,IACzC,WAAW;AAAA,IACX,WAAW;AAAA,IACX,UAAU,MAAM;AAAA,EAClB;AACF;AASO,SAAS,iBACd,WACA,KACG;AACH,SAAO;AAAA,IACL,GAAG;AAAA,IACH,gBAAgB,CAAC,GAAG,UAAU,gBAAgB,GAAG;AAAA,IACjD,WAAW,oBAAI,KAAK;AAAA,EACtB;AACF;AAKO,SAAS,cACd,WACA,KACc;AACd,SAAO;AAAA,IACL,GAAG;AAAA,IACH,aAAa,CAAC,GAAG,UAAU,aAAa,GAAG;AAAA,IAC3C,WAAW,oBAAI,KAAK;AAAA,EACtB;AACF;AAKO,SAAS,kBACd,WACA,UACA,SAKc;AACd,QAAM,MAAM,oBAAI,KAAK;AACrB,QAAM,gBAAgB,UAAU,WAAW;AAE3C,QAAM,YAA6B;AAAA,IACjC,OAAO;AAAA,IACP,OAAO;AAAA,IACP,iBAAiB,SAAS,QAAQ,aAAa;AAAA,IAC/C,OAAO,SAAS;AAAA,IAChB,UAAU,SAAS;AAAA,IACnB,OAAO,SAAS;AAAA,EAClB;AAEA,QAAM,kBAAmC;AAAA,IACvC,OAAO,SAAS,QAAQ,SAAS;AAAA,IACjC,MAAM;AAAA,IACN,IAAI;AAAA,IACJ,OAAO,SAAS;AAAA,IAChB,UAAU,SAAS;AAAA,IACnB,WAAW;AAAA,IACX,OAAO,SAAS;AAAA,EAClB;AAEA,SAAO;AAAA,IACL,GAAG;AAAA,IACH;AAAA,IACA,YAAY,CAAC,GAAG,UAAU,YAAY,eAAe;AAAA,IACrD,WAAW;AAAA,EACb;AACF;AAKO,SAAS,cACd,WACA,OACc;AACd,QAAM,MAAM,oBAAI,KAAK;AAErB,QAAM,kBAAmC;AAAA,IACvC,OAAO;AAAA,IACP,MAAM,UAAU,WAAW;AAAA,IAC3B,WAAW;AAAA,IACX;AAAA,EACF;AAEA,SAAO;AAAA,IACL,GAAG;AAAA,IACH,YAAY,CAAC,GAAG,UAAU,YAAY,eAAe;AAAA,IACrD,WAAW;AAAA,IACX,UAAU;AAAA,MACR,GAAG,UAAU;AAAA,MACb,QAAQ;AAAA,MACR,UAAU,IAAI,YAAY;AAAA,IAC5B;AAAA,EACF;AACF;AAgBO,SAAS,kBAAkB,WAAwC;AACxE,QAAM,SAAmB,CAAC;AAC1B,QAAM,WAAqB,CAAC;AAG5B,MAAI,CAAC,UAAU,QAAS,QAAO,KAAK,iBAAiB;AACrD,MAAI,CAAC,UAAU,KAAM,QAAO,KAAK,cAAc;AAC/C,MAAI,CAAC,UAAU,GAAI,QAAO,KAAK,YAAY;AAC3C,MAAI,CAAC,UAAU,OAAO,KAAM,QAAO,KAAK,oBAAoB;AAC5D,MAAI,CAAC,UAAU,OAAO,OAAQ,QAAO,KAAK,sBAAsB;AAChE,MAAI,UAAU,SAAS,WAAW,EAAG,QAAO,KAAK,+BAA+B;AAGhF,MAAI,UAAU,SAAS,OAAO;AAC5B,UAAM,MAAM;AACZ,QAAI,CAAC,IAAI,MAAM,KAAM,QAAO,KAAK,mBAAmB;AACpD,QAAI,CAAC,IAAI,MAAM,SAAU,QAAO,KAAK,wBAAwB;AAC7D,QAAI,IAAI,MAAM,QAAQ,EAAG,QAAO,KAAK,mBAAmB;AAAA,EAC1D,WAAW,UAAU,SAAS,MAAM;AAClC,UAAM,KAAK;AACX,QAAI,GAAG,OAAO,eAAe,OAAO,CAAC,GAAG;AACtC,aAAO,KAAK,+BAA+B;AAAA,IAC7C;AACA,QAAI,GAAG,OAAO,WAAW,KAAK,GAAG,OAAO,WAAW,IAAI;AACrD,aAAO,KAAK,uBAAuB;AAAA,IACrC;AAAA,EACF;AAGA,MAAI,UAAU,eAAe,WAAW,GAAG;AACzC,aAAS,KAAK,uCAAuC;AAAA,EACvD;AACA,MAAI,UAAU,SAAS,OAAO;AAC5B,UAAM,MAAM;AACZ,QAAI,IAAI,YAAY,WAAW,GAAG;AAChC,eAAS,KAAK,2CAA2C;AAAA,IAC3D;AACA,QAAI,CAAC,IAAI,MAAM,aAAa;AAC1B,eAAS,KAAK,gDAAgD;AAAA,IAChE;AAAA,EACF;AAGA,QAAM,aAAa,UAAU,SAAS,OAAO,CAAC,KAAK,MAAM,MAAM,EAAE,OAAO,CAAC;AACzE,MAAI,KAAK,IAAI,aAAa,GAAG,IAAI,MAAM;AACrC,aAAS,KAAK,yBAAyB,UAAU,kBAAkB;AAAA,EACrE;AAEA,SAAO;AAAA,IACL,OAAO,OAAO,WAAW;AAAA,IACzB;AAAA,IACA;AAAA,EACF;AACF;AASO,SAAS,eAAe,WAAiD;AAC9E,SAAO,UAAU,SAAS;AAC5B;AAKO,SAAS,cAAc,WAAgD;AAC5E,SAAO,UAAU,SAAS;AAC5B;AAKO,SAAS,SAAS,WAA+B;AACtD,SAAO,UAAU,eAAe,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,aAAa;AAC7E;AAKO,SAAS,SAAS,WAAkC;AACzD,SAAO,UAAU,YAAY,SAAS;AACxC;AASO,SAAS,mBAAmB,WAA8B;AAE/D,QAAM,eAAe,EAAE,GAAG,UAAU;AACpC,MAAI,eAAe,YAAY,KAAK,aAAa,SAAS;AAExD,UAAM,SAAS,OAAO,KAAK,aAAa,OAAO,EAAE,SAAS,QAAQ;AAClE,IAAC,aAAyC,gBAAgB;AAC1D,WAAQ,aAAyC;AAAA,EACnD;AAGA,SAAO,KAAK;AAAA,IACV;AAAA,IACA,CAAC,GAAG,UAAW,OAAO,UAAU,WAAW,MAAM,SAAS,IAAI,MAAM;AAAA,IACpE;AAAA,EACF;AACF;AAKO,SAAS,qBAAqB,MAAyB;AAC5D,QAAM,SAAS,KAAK,MAAM,MAAM,CAAC,GAAG,UAAU;AAE5C,QAAI,OAAO,UAAU,YAAY,MAAM,SAAS,GAAG,GAAG;AACpD,YAAM,MAAM,MAAM,MAAM,GAAG,EAAE;AAC7B,UAAI,QAAQ,KAAK,GAAG,GAAG;AACrB,eAAO,OAAO,GAAG;AAAA,MACnB;AAAA,IACF;AAEA,QAAI,OAAO,UAAU,YAAY,sBAAsB,KAAK,KAAK,GAAG;AAClE,aAAO,IAAI,KAAK,KAAK;AAAA,IACvB;AACA,WAAO;AAAA,EACT,CAAC;AAGD,MAAI,OAAO,eAAe;AACxB,WAAO,UAAU,IAAI,WAAW,OAAO,KAAK,OAAO,eAAe,QAAQ,CAAC;AAC3E,WAAO,OAAO;AAAA,EAChB;AAEA,SAAO;AACT;AAKO,SAAS,sBAAsB,WAA8B;AAClE,SAAO,UAAU,SAAS,QAAQ,SAAS;AAC7C;AAKO,SAAS,qBAAqB,WAA8B;AACjE,QAAM,WAAW,UAAU,MAAM,OAAO,YAAY;AACpD,SAAO,GAAG,QAAQ,GAAG,sBAAsB,SAAS,CAAC;AACvD;","names":[]}