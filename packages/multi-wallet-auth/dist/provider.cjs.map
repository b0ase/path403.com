{"version":3,"sources":["../src/provider.tsx"],"sourcesContent":["'use client';\n\n/**\n * Unified Wallet Provider\n *\n * React context that provides multi-wallet authentication\n * for HandCash, Yours, Phantom, and MetaMask.\n */\n\nimport React, {\n  createContext,\n  useContext,\n  useState,\n  useEffect,\n  useCallback,\n  ReactNode,\n} from 'react';\nimport type {\n  WalletProvider as WalletProviderType,\n  WalletContext,\n  WalletState,\n  Chain,\n  PROVIDER_CHAINS,\n} from './types';\n\n// Re-export types\nexport type { WalletProviderType, WalletContext, WalletState, Chain };\n\n// ============================================================================\n// Context\n// ============================================================================\n\nconst defaultState: WalletContext = {\n  isConnected: false,\n  provider: null,\n  address: null,\n  publicKey: null,\n  chain: null,\n  isConnecting: false,\n  error: null,\n  connect: async () => {},\n  disconnect: async () => {},\n};\n\nconst WalletCtx = createContext<WalletContext>(defaultState);\n\n// ============================================================================\n// Hook\n// ============================================================================\n\n/**\n * Use the wallet context\n *\n * @example\n * ```tsx\n * const { isConnected, address, connect, disconnect } = useWallet();\n *\n * if (isConnected) {\n *   return <div>Connected: {address}</div>;\n * }\n *\n * return <button onClick={() => connect('handcash')}>Connect</button>;\n * ```\n */\nexport function useWallet(): WalletContext {\n  const ctx = useContext(WalletCtx);\n  if (!ctx) {\n    throw new Error('useWallet must be used within MultiWalletProvider');\n  }\n  return ctx;\n}\n\n// ============================================================================\n// Provider Props\n// ============================================================================\n\nexport interface MultiWalletProviderProps {\n  children: ReactNode;\n  /** HandCash OAuth redirect URL (defaults to /api/auth/handcash) */\n  handcashAuthUrl?: string;\n  /** Whether to persist wallet selection to localStorage */\n  persistSelection?: boolean;\n  /** Storage key for persisted wallet */\n  storageKey?: string;\n  /** Callback when wallet connects */\n  onConnect?: (provider: WalletProviderType, address: string) => void;\n  /** Callback when wallet disconnects */\n  onDisconnect?: () => void;\n  /** Callback on connection error */\n  onError?: (error: Error) => void;\n}\n\n// ============================================================================\n// Provider Component\n// ============================================================================\n\n/**\n * Multi-Wallet Provider\n *\n * Wraps your app to provide unified wallet authentication.\n *\n * @example\n * ```tsx\n * import { MultiWalletProvider } from '@b0ase/multi-wallet-auth/provider';\n *\n * function App() {\n *   return (\n *     <MultiWalletProvider handcashAuthUrl=\"/api/auth/handcash\">\n *       <YourApp />\n *     </MultiWalletProvider>\n *   );\n * }\n * ```\n */\nexport function MultiWalletProvider({\n  children,\n  handcashAuthUrl = '/api/auth/handcash',\n  persistSelection = true,\n  storageKey = 'b0ase_wallet',\n  onConnect,\n  onDisconnect,\n  onError,\n}: MultiWalletProviderProps) {\n  const [state, setState] = useState<WalletState>({\n    isConnected: false,\n    provider: null,\n    address: null,\n    publicKey: null,\n    chain: null,\n    isConnecting: false,\n    error: null,\n  });\n\n  // Get chain for provider\n  const getChain = (provider: WalletProviderType): Chain => {\n    const chains: Record<WalletProviderType, Chain> = {\n      handcash: 'bsv',\n      yours: 'bsv',\n      phantom: 'solana',\n      metamask: 'ethereum',\n    };\n    return chains[provider];\n  };\n\n  // Check for HandCash session on mount\n  useEffect(() => {\n    const getCookie = (name: string): string | null => {\n      if (typeof document === 'undefined') return null;\n      const value = `; ${document.cookie}`;\n      const parts = value.split(`; ${name}=`);\n      if (parts.length === 2) return parts.pop()?.split(';').shift() || null;\n      return null;\n    };\n\n    const authToken = getCookie('b0ase_auth_token');\n    const handle = getCookie('b0ase_user_handle');\n\n    if (authToken && handle) {\n      setState((prev) => ({\n        ...prev,\n        isConnected: true,\n        provider: 'handcash',\n        address: handle,\n        chain: 'bsv',\n      }));\n    }\n  }, []);\n\n  // Restore persisted wallet selection\n  useEffect(() => {\n    if (!persistSelection || typeof window === 'undefined') return;\n\n    const stored = localStorage.getItem(storageKey);\n    if (stored) {\n      try {\n        const { provider, address } = JSON.parse(stored);\n        if (provider && address) {\n          setState((prev) => ({\n            ...prev,\n            isConnected: true,\n            provider,\n            address,\n            chain: getChain(provider),\n          }));\n        }\n      } catch {\n        localStorage.removeItem(storageKey);\n      }\n    }\n  }, [persistSelection, storageKey]);\n\n  // Connect to wallet\n  const connect = useCallback(\n    async (provider: WalletProviderType) => {\n      setState((prev) => ({ ...prev, isConnecting: true, error: null }));\n\n      try {\n        let address: string | null = null;\n        let publicKey: string | null = null;\n\n        switch (provider) {\n          case 'handcash': {\n            // Redirect to HandCash OAuth\n            const returnTo =\n              typeof window !== 'undefined' ? window.location.pathname : '/';\n            window.location.href = `${handcashAuthUrl}?returnTo=${encodeURIComponent(returnTo)}`;\n            return; // Page will redirect\n          }\n\n          case 'yours': {\n            // Yours wallet requires extension\n            if (typeof window === 'undefined') {\n              throw new Error('Yours wallet only works in browser');\n            }\n            // Yours integration typically done via their provider\n            // This is a simplified version - full integration uses YoursProvider\n            throw new Error(\n              'Yours wallet requires YoursWalletProvider wrapper'\n            );\n          }\n\n          case 'phantom': {\n            const solana = window.solana;\n            if (!solana?.isPhantom) {\n              window.open('https://phantom.app/', '_blank');\n              throw new Error('Phantom wallet not installed');\n            }\n            const resp = await solana.connect();\n            address = resp.publicKey.toString();\n            publicKey = address;\n            break;\n          }\n\n          case 'metamask': {\n            const ethereum = window.ethereum;\n            if (!ethereum?.isMetaMask) {\n              window.open('https://metamask.io/', '_blank');\n              throw new Error('MetaMask not installed');\n            }\n            const accounts = await ethereum.request<string[]>({\n              method: 'eth_requestAccounts',\n            });\n            address = accounts?.[0] || null;\n            break;\n          }\n        }\n\n        if (!address) {\n          throw new Error('Failed to get wallet address');\n        }\n\n        const chain = getChain(provider);\n\n        setState({\n          isConnected: true,\n          provider,\n          address,\n          publicKey,\n          chain,\n          isConnecting: false,\n          error: null,\n        });\n\n        // Persist selection\n        if (persistSelection && typeof window !== 'undefined') {\n          localStorage.setItem(storageKey, JSON.stringify({ provider, address }));\n        }\n\n        // Callback\n        onConnect?.(provider, address);\n      } catch (err) {\n        const error = err instanceof Error ? err : new Error(String(err));\n        setState((prev) => ({\n          ...prev,\n          isConnecting: false,\n          error: error.message,\n        }));\n        onError?.(error);\n      }\n    },\n    [handcashAuthUrl, persistSelection, storageKey, onConnect, onError]\n  );\n\n  // Disconnect wallet\n  const disconnect = useCallback(async () => {\n    try {\n      const { provider } = state;\n\n      if (provider === 'phantom' && window.solana) {\n        await window.solana.disconnect();\n      }\n      // MetaMask doesn't have a disconnect method\n      // HandCash requires clearing cookies (server-side)\n\n      setState({\n        isConnected: false,\n        provider: null,\n        address: null,\n        publicKey: null,\n        chain: null,\n        isConnecting: false,\n        error: null,\n      });\n\n      // Clear persisted selection\n      if (persistSelection && typeof window !== 'undefined') {\n        localStorage.removeItem(storageKey);\n      }\n\n      // Callback\n      onDisconnect?.();\n    } catch (err) {\n      console.error('Disconnect error:', err);\n    }\n  }, [state, persistSelection, storageKey, onDisconnect]);\n\n  // Sign message (for wallets that support it)\n  const signMessage = useCallback(\n    async (message: string): Promise<string> => {\n      const { provider } = state;\n\n      if (!provider) {\n        throw new Error('No wallet connected');\n      }\n\n      switch (provider) {\n        case 'phantom': {\n          if (!window.solana) throw new Error('Phantom not available');\n          const encodedMessage = new TextEncoder().encode(message);\n          const { signature } = await window.solana.signMessage(\n            encodedMessage,\n            'utf8'\n          );\n          return Buffer.from(signature).toString('hex');\n        }\n\n        case 'metamask': {\n          if (!window.ethereum) throw new Error('MetaMask not available');\n          const address = state.address;\n          if (!address) throw new Error('No address');\n          const signature = await window.ethereum.request<string>({\n            method: 'personal_sign',\n            params: [message, address],\n          });\n          return signature || '';\n        }\n\n        default:\n          throw new Error(`Signing not supported for ${provider}`);\n      }\n    },\n    [state]\n  );\n\n  const value: WalletContext = {\n    ...state,\n    connect,\n    disconnect,\n    signMessage,\n  };\n\n  return <WalletCtx.Provider value={value}>{children}</WalletCtx.Provider>;\n}\n\n// ============================================================================\n// Export default for convenience\n// ============================================================================\n\nexport default MultiWalletProvider;\n"],"mappings":"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","names":["value"]}