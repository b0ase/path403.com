{"version":3,"sources":["../src/server.ts"],"sourcesContent":["/**\n * Server-Side Wallet Utilities\n *\n * Functions for validating wallet authentication on the server.\n */\n\nimport type {\n  WalletProvider,\n  WalletAuthRequest,\n  WalletAuthResponse,\n  WalletSession,\n  Chain,\n  PROVIDER_CHAINS,\n} from './types';\n\n// Re-export types\nexport type {\n  WalletProvider,\n  WalletAuthRequest,\n  WalletAuthResponse,\n  WalletSession,\n};\n\n// ============================================================================\n// Address Validation\n// ============================================================================\n\n/**\n * Validate Ethereum address format\n */\nexport function isValidEthereumAddress(address: string): boolean {\n  return /^0x[a-fA-F0-9]{40}$/.test(address);\n}\n\n/**\n * Validate Solana address format (base58, 32-44 chars)\n */\nexport function isValidSolanaAddress(address: string): boolean {\n  return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);\n}\n\n/**\n * Validate BSV address format (starts with 1 or m/n for testnet)\n */\nexport function isValidBsvAddress(address: string): boolean {\n  return /^[1mn][a-km-zA-HJ-NP-Z0-9]{25,34}$/.test(address);\n}\n\n/**\n * Validate HandCash handle format\n */\nexport function isValidHandCashHandle(handle: string): boolean {\n  return /^[a-zA-Z0-9_]{1,20}$/.test(handle);\n}\n\n/**\n * Validate address for a given provider\n */\nexport function validateAddress(\n  provider: WalletProvider,\n  address: string\n): boolean {\n  switch (provider) {\n    case 'handcash':\n      return isValidHandCashHandle(address);\n    case 'yours':\n      return isValidBsvAddress(address);\n    case 'phantom':\n      return isValidSolanaAddress(address);\n    case 'metamask':\n      return isValidEthereumAddress(address);\n    default:\n      return false;\n  }\n}\n\n// ============================================================================\n// Address Normalization\n// ============================================================================\n\n/**\n * Normalize address for consistent storage\n * - Ethereum addresses: lowercase\n * - Others: as-is\n */\nexport function normalizeAddress(\n  provider: WalletProvider,\n  address: string\n): string {\n  if (provider === 'metamask') {\n    return address.toLowerCase();\n  }\n  return address;\n}\n\n// ============================================================================\n// Session Utilities\n// ============================================================================\n\n/**\n * Parse wallet session from cookies\n */\nexport function parseWalletSession(\n  cookies: Record<string, string | undefined>\n): WalletSession | null {\n  const provider = cookies['b0ase_wallet_provider'] as WalletProvider;\n  const address = cookies['b0ase_wallet_address'];\n\n  if (!provider || !address) {\n    // Check for HandCash cookies\n    const authToken = cookies['b0ase_auth_token'];\n    const handle = cookies['b0ase_user_handle'];\n\n    if (authToken && handle) {\n      return {\n        provider: 'handcash',\n        address: handle,\n        chain: 'bsv',\n      };\n    }\n\n    return null;\n  }\n\n  const chains: Record<WalletProvider, Chain> = {\n    handcash: 'bsv',\n    yours: 'bsv',\n    phantom: 'solana',\n    metamask: 'ethereum',\n  };\n\n  return {\n    provider,\n    address,\n    chain: chains[provider],\n  };\n}\n\n/**\n * Create session cookies for wallet auth\n */\nexport function createSessionCookies(\n  provider: WalletProvider,\n  address: string,\n  maxAge = 2592000 // 30 days\n): string[] {\n  const options = `Path=/; Max-Age=${maxAge}; SameSite=Lax`;\n  return [\n    `b0ase_wallet_provider=${provider}; ${options}`,\n    `b0ase_wallet_address=${normalizeAddress(provider, address)}; ${options}`,\n  ];\n}\n\n/**\n * Create cookies to clear wallet session\n */\nexport function clearSessionCookies(): string[] {\n  const options = 'Path=/; Max-Age=0; SameSite=Lax';\n  return [\n    `b0ase_wallet_provider=; ${options}`,\n    `b0ase_wallet_address=; ${options}`,\n  ];\n}\n\n// ============================================================================\n// Auth Handler Helpers\n// ============================================================================\n\n/**\n * Validate wallet auth request\n */\nexport function validateAuthRequest(\n  body: unknown\n): { valid: true; data: WalletAuthRequest } | { valid: false; error: string } {\n  if (!body || typeof body !== 'object') {\n    return { valid: false, error: 'Invalid request body' };\n  }\n\n  const { provider, address } = body as Record<string, unknown>;\n\n  if (!provider || typeof provider !== 'string') {\n    return { valid: false, error: 'provider is required' };\n  }\n\n  if (!address || typeof address !== 'string') {\n    return { valid: false, error: 'address is required' };\n  }\n\n  const validProviders: WalletProvider[] = [\n    'handcash',\n    'yours',\n    'phantom',\n    'metamask',\n  ];\n  if (!validProviders.includes(provider as WalletProvider)) {\n    return {\n      valid: false,\n      error: `Invalid provider. Must be one of: ${validProviders.join(', ')}`,\n    };\n  }\n\n  if (!validateAddress(provider as WalletProvider, address)) {\n    return { valid: false, error: 'Invalid address format for provider' };\n  }\n\n  return {\n    valid: true,\n    data: {\n      provider: provider as WalletProvider,\n      address: normalizeAddress(provider as WalletProvider, address),\n    },\n  };\n}\n\n// ============================================================================\n// Display Name Generation\n// ============================================================================\n\n/**\n * Generate display name from wallet address\n */\nexport function generateDisplayName(\n  provider: WalletProvider,\n  address: string\n): string {\n  if (provider === 'handcash') {\n    return `$${address}`;\n  }\n\n  if (provider === 'metamask') {\n    return `${address.slice(0, 6)}...${address.slice(-4)}`;\n  }\n\n  if (provider === 'phantom') {\n    return `${address.slice(0, 4)}...${address.slice(-4)}`;\n  }\n\n  // BSV addresses\n  return `${address.slice(0, 6)}...${address.slice(-4)}`;\n}\n\n// ============================================================================\n// Chain Utilities\n// ============================================================================\n\n/**\n * Get chain for provider\n */\nexport function getChainForProvider(provider: WalletProvider): Chain {\n  const chains: Record<WalletProvider, Chain> = {\n    handcash: 'bsv',\n    yours: 'bsv',\n    phantom: 'solana',\n    metamask: 'ethereum',\n  };\n  return chains[provider];\n}\n\n/**\n * Get explorer URL for transaction\n */\nexport function getExplorerUrl(chain: Chain, txid: string): string {\n  switch (chain) {\n    case 'bsv':\n      return `https://whatsonchain.com/tx/${txid}`;\n    case 'ethereum':\n      return `https://etherscan.io/tx/${txid}`;\n    case 'solana':\n      return `https://solscan.io/tx/${txid}`;\n  }\n}\n\n/**\n * Get explorer URL for address\n */\nexport function getAddressExplorerUrl(chain: Chain, address: string): string {\n  switch (chain) {\n    case 'bsv':\n      return `https://whatsonchain.com/address/${address}`;\n    case 'ethereum':\n      return `https://etherscan.io/address/${address}`;\n    case 'solana':\n      return `https://solscan.io/account/${address}`;\n  }\n}\n"],"mappings":"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","names":[]}