"use client";

import React, { Component, ErrorInfo, ReactNode, Suspense } from "react";
import dynamic from "next/dynamic";
import { StudioProvider, useStudio } from "@/components/studio/studio-context";
import ProjectTabs from "@/components/studio/project-tabs";

// Color theme background classes mapping
const themeBackgrounds: Record<string, string> = {
  black: 'bg-black text-white',
  white: 'bg-white text-black',
  yellow: 'bg-amber-400 text-black',
  red: 'bg-red-500 text-black',
  green: 'bg-green-500 text-black',
  blue: 'bg-blue-500 text-black',
};

// Lazy load heavy components
const VideoTimeline = dynamic(() => import("@/components/studio/video-timeline"), {
  ssr: false,
  loading: () => <div className="mx-2 mt-2 p-2 bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-[88px] animate-pulse" />
});

const AudioTimeline = dynamic(() => import("@/components/studio/audio-timeline"), {
  ssr: false,
  loading: () => <div className="mx-2 mt-2 p-2 bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-[88px] animate-pulse" />
});

const SuperEffects = dynamic(() => import("@/components/studio/super-effects"), {
  ssr: false,
  loading: () => <div className="bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-64 animate-pulse" />
});

const Effects = dynamic(() => import("@/components/studio/effects"), {
  ssr: false,
  loading: () => <div className="bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-64 animate-pulse" />
});

const Preview = dynamic(() => import("@/components/studio/preview"), {
  ssr: false,
  loading: () => <div className="bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-full animate-pulse" />
});

const Settings = dynamic(() => import("@/components/studio/settings"), {
  ssr: false,
  loading: () => <div className="bg-gray-100 dark:bg-[#050505] rounded-lg border border-black/5 dark:border-white/5 h-64 animate-pulse" />
});

// Error boundary to catch any crashes
interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

class ErrorBoundary extends Component<{ children: ReactNode; fallback?: ReactNode }, ErrorBoundaryState> {
  constructor(props: { children: ReactNode; fallback?: ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Studio Error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="p-4 bg-red-900/20 border border-red-500 rounded m-4">
          <h2 className="text-red-400 font-bold">Something went wrong</h2>
          <p className="text-red-300 text-sm mt-2">{this.state.error?.message}</p>
        </div>
      );
    }
    return this.props.children;
  }
}

// Inner component that uses the context
function StudioContent() {
  const { activeProject, setActiveProject, clips, audioTracks, colorTheme, isDark } = useStudio();

  return (
    <div className={`min-h-screen flex flex-col font-sans overflow-hidden relative ${themeBackgrounds[colorTheme] || themeBackgrounds.black}`}>
      {/* Project Tabs */}
      <ProjectTabs
        activeProject={activeProject}
        onProjectChange={setActiveProject}
        videoCount={clips.length}
        audioCount={audioTracks.length}
        colorTheme={colorTheme}
        isDark={isDark}
      />

      {/* Main Layout: Left (Timelines + Controls) | Right (Preview) */}
      <div className="flex-1 flex gap-2 p-2 overflow-hidden">
        {/* Left Column: Timelines + Control Panels */}
        <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
          {/* Timelines */}
          <div className="flex-none">
            <ErrorBoundary>
              <VideoTimeline />
            </ErrorBoundary>
            <ErrorBoundary>
              <AudioTimeline />
            </ErrorBoundary>
          </div>

          {/* Control Panels Row: SuperEffects | Effects | Settings - fill available space */}
          <div className="flex-1 flex gap-2 mt-2 min-h-0">
            {/* 1. Super Effects */}
            <div className="flex-1 min-w-[200px] overflow-y-auto no-scrollbar scroll-smooth">
              <ErrorBoundary><SuperEffects /></ErrorBoundary>
            </div>

            {/* 2. Effects (includes Filters + Text) */}
            <div className="flex-1 min-w-[200px] overflow-y-auto no-scrollbar scroll-smooth">
              <ErrorBoundary><Effects /></ErrorBoundary>
            </div>

            {/* 3. Settings */}
            <div className="flex-1 min-w-[200px] overflow-y-auto no-scrollbar scroll-smooth">
              <ErrorBoundary><Settings /></ErrorBoundary>
            </div>
          </div>
        </div>

        {/* Right Column: Preview (full height) */}
        <div className="flex-none w-[300px] flex flex-col overflow-hidden">
          <ErrorBoundary><Preview /></ErrorBoundary>
        </div>
      </div>

      {/* Global Scrollbar Styles for this page */}
      <style jsx global>{`
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .no-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      `}</style>
    </div>
  );
}

export default function StudioPage() {
  return (
    <ErrorBoundary
      fallback={
        <div className="p-4 min-h-screen">
          <div className="bg-red-900/20 border border-red-500 rounded p-4 mb-4">
            <h2 className="text-red-400 font-bold">Context Error</h2>
            <p className="text-red-300 text-sm mt-2">Failed to load studio context. Check console for details.</p>
          </div>
          <ProjectTabs />
        </div>
      }
    >
      <StudioProvider>
        <StudioContent />
      </StudioProvider>
    </ErrorBoundary>
  );
}
