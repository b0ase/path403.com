import { NextRequest, NextResponse } from 'next/server';
import { getDbPool } from '@/lib/database/pool';


export const dynamic = 'force-dynamic';

export async function GET() {
  try {
    const result = await pool.query(`
      SELECT
        sa.*,
        COUNT(DISTINCT pq.id) as queue_count,
        COUNT(DISTINCT pc.id) as posted_count
      FROM social_accounts sa
      LEFT JOIN post_queue pq ON sa.id = pq.social_account_id AND pq.status = 'queued'
      LEFT JOIN posted_content pc ON sa.id = pc.social_account_id
      GROUP BY sa.id
      ORDER BY sa.site, sa.platform, sa.handle
    `);

    return NextResponse.json({ accounts: result.rows });
  } catch (error: any) {
    console.error('Error fetching social accounts:', error);
    return NextResponse.json(
      { error: 'Failed to fetch accounts', details: error.message },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const { site, platform, handle, profile_url } = await request.json();

    if (!site || !platform || !handle || !profile_url) {
      return NextResponse.json(
        { error: 'All fields required: site, platform, handle, profile_url' },
        { status: 400 }
      );
    }

    const result = await pool.query(
      `INSERT INTO social_accounts (site, platform, handle, profile_url, active)
       VALUES ($1, $2, $3, $4, true)
       RETURNING *`,
      [site, platform, handle, profile_url]
    );

    return NextResponse.json({
      success: true,
      account: result.rows[0],
    });
  } catch (error: any) {
    if (error.code === '23505') { // Unique constraint violation
      return NextResponse.json(
        { error: 'Account already exists for this site/platform/handle combination' },
        { status: 409 }
      );
    }
    console.error('Error creating social account:', error);
    return NextResponse.json(
      { error: 'Failed to create account', details: error.message },
      { status: 500 }
    );
  }
}
